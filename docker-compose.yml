# ClawQuake Local Dev Setup
# Run with: docker-compose up -d --build
#
# QuakeJS game server + orchestrator + nginx
# Browser client: http://localhost:8080
# API / Dashboard: http://localhost
#
# Requires: .env file with JWT_SECRET, RCON_PASSWORD, INTERNAL_SECRET

version: "3.8"

services:
  # ── QuakeJS Game Server (WebSocket-native ioquake3) ────
  gameserver-1:
    build:
      context: ./quakejs
      dockerfile: Dockerfile
    container_name: clawquake-server-1
    ports:
      - "27960:27960/tcp"
      - "8080:8080"
    environment:
      - SERVER_ID=server-1
    restart: unless-stopped

  # ── Orchestrator API ───────────────────────────────────
  orchestrator:
    build:
      context: .
      dockerfile: orchestrator/Dockerfile
    container_name: clawquake-orchestrator
    ports:
      - "8000:8000"
    environment:
      - JWT_SECRET=${JWT_SECRET:?Set JWT_SECRET in .env}
      - RCON_PASSWORD=${RCON_PASSWORD:?Set RCON_PASSWORD in .env}
      - INTERNAL_SECRET=${INTERNAL_SECRET:-changeme}
      - MATCH_DURATION=${MATCH_DURATION:-120}
      - QUEUE_POLL_INTERVAL=${QUEUE_POLL_INTERVAL:-5}
      - GAME_SERVER_HOST=gameserver-1
      - GAME_SERVER_URLS=ws://gameserver-1:27960
    volumes:
      - ./strategies:/app/strategies:ro
      - ./results:/app/results
      - clawquake-data:/app/data
    depends_on:
      - gameserver-1
    restart: unless-stopped

  # ── Spectator Stream (HLS) ─────────────────────────────
  spectator:
    build:
      context: ./spectator
      dockerfile: Dockerfile
    container_name: clawquake-spectator
    environment:
      - GAME_SERVER_HOST=gameserver-1
      - GAME_SERVER_PORT=27960
    depends_on:
      - gameserver-1
    restart: unless-stopped

  # ── Nginx Reverse Proxy ────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: clawquake-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./web:/usr/share/nginx/html:ro
    depends_on:
      - orchestrator
      - spectator
    restart: unless-stopped

volumes:
  clawquake-data:
