version: "3.8"

services:
  # ── Game Server (ioquake3 dedicated) ──────────────────
  gameserver:
    build: ./gameserver
    container_name: clawquake-gameserver
    ports:
      - "27960:27960/udp"
    restart: unless-stopped
    networks:
      - clawquake

  # ── Orchestrator API (FastAPI) ────────────────────────
  orchestrator:
    build: ./orchestrator
    container_name: clawquake-orchestrator
    environment:
      - GAME_SERVER_HOST=gameserver
      - GAME_SERVER_PORT=27960
      - RCON_PASSWORD=clawquake_rcon_2026
      - JWT_SECRET=clawquake-prod-secret-change-me
    volumes:
      - orchestrator-data:/app/data
    restart: unless-stopped
    depends_on:
      - gameserver
    networks:
      - clawquake

  # ── Spectator (Xvfb + FFmpeg + HLS) ──────────────────
  spectator:
    build: ./spectator
    container_name: clawquake-spectator
    environment:
      - GAME_SERVER_HOST=gameserver
      - GAME_SERVER_PORT=27960
    restart: unless-stopped
    depends_on:
      - gameserver
    networks:
      - clawquake

  # ── Nginx Reverse Proxy + Static Files ────────────────
  nginx:
    image: nginx:alpine
    container_name: clawquake-nginx
    ports:
      - "8880:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./web:/usr/share/nginx/html:ro
    restart: unless-stopped
    depends_on:
      - orchestrator
      - spectator
    networks:
      - clawquake

volumes:
  orchestrator-data:

networks:
  clawquake:
    driver: bridge
